<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>jsPsych Subject Feedback</title>
  <script src="jspsych/jspsych.js"></script>
  <script src="jspsych/plugins/jspsych-preload.js"></script>
  <link href="jspsych/css/jspsych.css" rel="stylesheet" type="text/css">
  <script src="src/jspsych-plugin-realtime-response.js"></script>
  <script src="src/jsPsychWebSocket.js"></script>
</head>

<body></body>

<script>
// connect to the project server to receive events
createWebSocket();

var timeline = []

// this function draws a circle with a brainstate radius
function drawCircle(canvas){
  var ctx = canvas.getContext('2d');
  var width = canvas.width
  var height = canvas.height
  var minDim = Math.min(width, height)
  var brainstate = FeedbackStatus.val * 0.66 * minDim
    ctx.beginPath();
    ctx.arc(width/2, height/2, 1*brainstate, 0, 2 * Math.PI);
    ctx.fillStyle = "green"
    ctx.fill()
    ctx.stroke();
}

// This creates a trial of type brain-realtime-response which
//  when triggered by an 'rtEvent' will switch to the next trial.
// The trial_duration is the minimal amount of time the trial takes
var feedbackNode = {
  type: 'brain-realtime-response',
  stimulus: drawCircle,
  canvas_size: [window.innerHeight, window.innerWidth],
  // QUESTION
  data: {shape: 'circle', radius: 50}, // QUESTION - how is data retrieved or used?
  // The on_start function redefines the circle radius when the trial is starting
  on_start: function(trial) {
    trial.data.radius = FeedbackStatus.val; // QUESTION - how is data retrieved?
  }
}

var messageNode = {
  type: 'brain-realtime-response',
  stimulus: null,
  prompt: FeedbackStatus.message,
  on_start: function(trial){
    trial.prompt = FeedbackStatus.message;
  }
};

var if_feedback_node = {
  timeline: [feedbackNode],
  conditional_function: function() {
    return FeedbackStatus.doFeedback
  }

}

var if_message_node = {
  timeline: [messageNode],
  conditional_function: function() {
    return !FeedbackStatus.doFeedback
  }

}

// This is a loop node that loops through the same trials with
//   updated feedback as long as the return condition is true
var loop_node = {
    timeline: [if_feedback_node, if_message_node],
    loop_function: function(data){
        return FeedbackStatus.connected
    }
}

// pushing the loop node
timeline.push(loop_node)


jsPsych.init({
      timeline: timeline,
       on_finish: function(){
        //  saveData("experiment_data", jsPsych.data.get().csv());
       }
});

</script>
<!--
  var welcome = {
    type: "html-keyboard-response",
    stimulus: "Welcome to the experiment. Press any key to begin."
  };
  timeline.push(welcome); -->

<!--
  /** This would be calling the saveData function every trial
   * Then you would have to rewrite it such that it only adds the latest trial's data

  timeline.push({
    type: 'call-function',
    func: saveData
  });
  **/
   -->
</html>
